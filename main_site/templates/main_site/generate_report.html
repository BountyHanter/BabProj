{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генерация отчета</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap4-theme/1.1.0/select2-bootstrap4.min.css" rel="stylesheet" />
    <style>
        /* Дополнительные стили для улучшения внешнего вида */
        .form-group label {
            font-weight: bold;
            display: flex;
            flex-direction: column;
        }
        .card {
            margin-bottom: 20px;
        }
        .select2-container .select2-selection--multiple {
            height: auto;
        }
        .help-text {
            font-size: 0.9em;
            color: #6c757d;
        }
        .select2-container {
            width: 100% !important;
        }
        .select-wrapper {
            position: relative;
            width: 100%;
        }
        .select2-container .select2-selection--multiple {
            height: auto;
            min-height: 38px;
            border-radius: 4px;
            padding: 5px;
            overflow: hidden;
        }

        .card-body .form-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Стили для модального окна */
        .modal-content {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            background-color: #ff0000;
            color: white;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .modal-footer {
            border-top: none;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Сформировать отчет</h2>
        <form id="reportForm" method="post">
            {% csrf_token %}

            <!-- Карточка выбора дат -->
            <div class="card">
                <div class="card-header">
                    Даты
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <!-- Дата создания -->
                        <div class="form-group col-md-6">
                            <label for="creation-date">Дата создания (От - До)</label>
                            <input type="date" class="form-control mb-2" id="creation-date-from" name="creation_date_from">
                            <input type="date" class="form-control" id="creation-date-to" name="creation_date_to">
                            <small class="help-text">Выберите диапазон дат для создания</small>
                        </div>
                        <!-- Дата выполнения -->
                        <div class="form-group col-md-6">
                            <label for="completion-date">Дата выполнения (От - До)</label>
                            <input type="date" class="form-control mb-2" id="completion-date-from" name="completion_date_from">
                            <input type="date" class="form-control" id="completion-date-to" name="completion_date_to">
                            <small class="help-text">Выберите диапазон дат для выполнения</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Диапазон ID заявки -->
            <div class="card">
                <div class="card-header">
                    Диапазон ID заявки
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="application-id-from">ID заявки (От)</label>
                            <input type="number" class="form-control" id="application-id-from" name="application_id_from" placeholder="Введите начальный ID">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="application-id-to">ID заявки (До)</label>
                            <input type="number" class="form-control" id="application-id-to" name="application_id_to" placeholder="Введите конечный ID">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Тип и Статус -->
            <div class="card">
                <div class="card-header">
                    Параметры транзакции
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="type">Тип</label>
                            <select class="form-control" id="type" name="type">
                                <option value="">Выберите тип</option>
                                <option value="c2c">C2C</option>
                                <option value="sbp">СБП</option>
                            </select>
                        </div>
                        <div class="form-group col-md-6">
                            <label for="status">Статус</label>
                            <select class="form-control select2" id="status" name="status[]" multiple="multiple">
                                <option value="new">New</option>
                                <option value="active">Active</option>
                                <option value="processing">Processing</option>
                                <option value="completed">Completed</option>
                                <option value="canceled">Canceled</option>
                                <option value="manual">Manual</option>
                            </select>
                            <small class="help-text">Выберите один или несколько статусов</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Банки -->
            <div class="card">
                <div class="card-header">
                    Банки
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <!-- Банк отправителя -->
                        <div class="form-group col-md-6">
                            <label for="from-bank-select">Банк отправителя</label>
                            <div class="select-wrapper">
                                <select class="form-control select2" id="from-bank-select" multiple="multiple" name="from_bank[]">
                                    <!-- Опции будут добавлены через JavaScript -->
                                </select>
                            </div>
                            <small class="help-text">Выберите один или несколько банков отправителей</small>
                        </div>
                        <!-- Банк получателя -->
                        <div class="form-group col-md-6">
                            <label for="to-bank-select">Банк получателя</label>
                            <div class="select-wrapper">
                                <select class="form-control select2" id="to-bank-select" multiple="multiple" name="to_bank[]">
                                    <!-- Опции будут добавлены через JavaScript -->
                                </select>
                            </div>
                            <small class="help-text">Выберите один или несколько банков получателей</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Диапазон суммы -->
            <div class="card">
                <div class="card-header">
                    Диапазон суммы
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label for="amount-from">Сумма (От)</label>
                            <input type="number" class="form-control" id="amount-from" name="amount_from" step="0.01" placeholder="Минимальная сумма">
                        </div>
                        <div class="form-group col-md-6">
                            <label for="amount-to">Сумма (До)</label>
                            <input type="number" class="form-control" id="amount-to" name="amount_to" step="0.01" placeholder="Максимальная сумма">
                        </div>
                    </div>
                </div>
            </div>

            {% if can_view_all_reports %}
            <!-- ID мерчанта и пользователя -->
            <div class="card">
                <div class="card-header">
                    Идентификаторы
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="merchant-id">ID мерчанта</label>
                        <input type="text" class="form-control" id="merchant-id" name="merchant_ids" placeholder="Введите ID через запятую">
                        <small class="help-text">Например: 123, 456, 789</small>
                    </div>
                    <div class="form-group">
                        <label for="user-id">ID пользователя</label>
                        <input type="text" class="form-control" id="user-id" name="user_ids" placeholder="Введите ID через запятую">
                        <small class="help-text">Например: 321, 654, 987</small>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Кнопка отправки -->
            <button type="button" class="btn btn-primary btn-block" id="submitBtn">Сформировать отчет</button>
        </form>
    </div>


    <!-- Модальное окно -->
    <div class="modal fade" id="infoModal" tabindex="-1" role="dialog" aria-labelledby="infoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="infoModalLabel">Внимание</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Отчет может формироваться некоторое время. Пожалуйста, ждите и ничего не делайте после запроса отчёта.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Я понял</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Скрипты -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        const banksData = {{ banks_json|safe }};
        const formattedBanksData = banksData.map((name, index) => ({
            id: index + 1,
            text: name
        }));

        $(document).ready(function() {
            // Функция для установки куки
            function setCookie(name, value, days) {
                const d = new Date();
                d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                const expires = "expires=" + d.toUTCString();
                document.cookie = name + "=" + value + ";" + expires + ";path=/";
            }

            // Функция для получения куки
            function getCookie(name) {
                const value = "; " + document.cookie;
                const parts = value.split("; " + name + "=");
                if (parts.length === 2) return parts.pop().split(";").shift();
            }

            // Проверяем, была ли кука установлена
            if (!getCookie("modalShown")) {
                // Если кука не установлена, показываем модальное окно
                $('#infoModal').modal('show');

                // Устанавливаем куку на 30 дней
                setCookie("modalShown", "true", 30);
            }

            $('#from-bank-select').select2({
                theme: 'bootstrap4',
                placeholder: '->',
                allowClear: true,
                width: 'resolve',
                data: formattedBanksData
            });

            $('#to-bank-select').select2({
                theme: 'bootstrap4',
                placeholder: '->',
                allowClear: true,
                width: 'resolve',
                data: formattedBanksData
            });

            $('#status').select2({
                theme: 'bootstrap4',
                placeholder: '->',
                allowClear: true,
                width: 'resolve'
            });

            // Обработчик отправки формы
            $('#submitBtn').click(function(e) {
                e.preventDefault();
                // Собираем данные формы
                const formData = {
                    application_id_from: $('#application-id-from').val(),
                    application_id_to: $('#application-id-to').val(),
                    type: $('#type').val(),
                    status: $('#status').val(),
                    from_bank: $('#from-bank-select').val(),
                    to_bank: $('#to-bank-select').val(),
                    amount_from: $('#amount-from').val(),
                    amount_to: $('#amount-to').val(),
                    merchant_ids: $('#merchant-id').val(),
                    user_ids: $('#user-id').val(),
                    creation_date_from: $('#creation-date-from').val(),
                    creation_date_to: $('#creation-date-to').val(),
                    completion_date_from: $('#completion-date-from').val(),
                    completion_date_to: $('#completion-date-to').val()
                };

                // Отправка AJAX-запроса
                $.ajax({
                    url: '{% url "generate_report" %}', // Замените на ваш URL
                    type: 'POST',
                    data: JSON.stringify(formData),
                    contentType: 'application/json; charset=utf-8',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        if (response.file_url) {
                            // Открываем файл в новой вкладке
                            window.location.href = response.file_url;
                        } else {
                            alert('Не удалось получить файл отчета');
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Произошла ошибка при генерации отчета');
                        console.error(error);
                    }

                });
            });
        });
    </script>

</body>
</html>
